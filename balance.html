<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üìä Balance General Arcade ‚Äî Juego de Contabilidad</title>
  <style>
    /* =========================================================
       BALANCE GENERAL ARCADE ‚Äî ESTILOS PRINCIPALES
       Autor: NEXTSKILL for David
       Descripci√≥n: Juego arcade educativo de contabilidad
       Secciones: Layout, Paneles, Botones, Drag&Drop, Modales
       ========================================================= */

    :root{
      --bg:#0b0f23; 
      --panel:#0f1634; 
      --panel-2:#111a42; 
      --ink:#eef1ff; 
      --muted:#aab3df; 
      --accent:#7c9cff; 
      --accent-2:#9ad1ff;
      --good:#34D399; 
      --warn:#FBBF24; 
      --bad:#F87171; 
      --chip:#1c265a; 
      --chip-ink:#d8dcff;
      --grid:rgba(255,255,255,.05);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --shadow-soft:0 6px 18px rgba(0,0,0,.25);
      --glass:rgba(255,255,255,.06);
      --glass-bd:rgba(255,255,255,.12);
    }

    html,body{height:100%;}
    body{
      margin:0; background: radial-gradient(1200px 600px at 20% -10%, #152158 0%, transparent 60%),
                                   radial-gradient(900px 600px at 120% 20%, #0e1746 0%, transparent 60%),
                                   linear-gradient(180deg, #0b0f23, #0b0f23);
      color:var(--ink); font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; 
      overflow-x:hidden;
    }

    .app{
      display:grid; grid-template-rows:auto auto 1fr auto; min-height:100dvh; gap:16px; padding:18px; 
      background-image: linear-gradient(transparent 0,transparent calc(100% - 140px), rgba(255,255,255,.02) calc(100% - 140px), rgba(255,255,255,.02) 100%);
    }

    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; text-decoration:none; color:var(--ink);
    }
    .logo{
      width:42px; height:42px; border-radius:14px; background:linear-gradient(135deg, #6fa3ff, #9ad1ff); 
      box-shadow:var(--shadow-soft); display:grid; place-items:center; font-weight:800; color:#0b0f23;
    }
    .title h1{margin:0; font-size:clamp(18px, 2.6vw, 28px);} 
    .title small{color:var(--muted);}    

    .top-actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      appearance:none; cursor:pointer; user-select:none; border:none; border-radius:12px; padding:10px 14px; font-weight:700; 
      color:#0b0f23; background:linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow:var(--shadow-soft); transition:.15s transform ease, .2s box-shadow ease;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow)}
    .btn:active{transform:translateY(0)}
    .btn.alt{background:linear-gradient(135deg, #ffb86b, #ffd38c)}
    .btn.ghost{background:transparent; color:var(--ink); outline:1px solid var(--glass-bd)}

    .hud{
      display:grid; grid-template-columns:1fr auto 1fr; gap:16px; align-items:stretch;
    }
    .panel{
      background:var(--panel); border:1px solid var(--glass-bd); border-radius:18px; padding:14px; box-shadow:var(--shadow-soft);
    }
    .scoreboard{display:flex; gap:12px; align-items:center; justify-content:flex-start; flex-wrap:wrap}
    .tag{background:var(--chip); color:var(--chip-ink); border:1px solid var(--glass-bd); padding:8px 10px; border-radius:999px; font-weight:700; display:flex; align-items:center; gap:8px}
    .tag .dot{width:9px; height:9px; background:var(--accent-2); border-radius:50%}

    .progress-wrap{display:flex; align-items:center; gap:12px}
    .progress{flex:1; height:10px; background:var(--glass); border-radius:999px; overflow:hidden; outline:1px solid var(--glass-bd)}
    .progress > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, #7c9cff, #9ad1ff)}

    .lives{display:flex; gap:4px}
    .life{
      width:20px; height:20px; border-radius:6px; background:linear-gradient(135deg, #ee7a7a, #f87171); border:1px solid rgba(255,255,255,.25);
      box-shadow: inset 0 0 10px rgba(0,0,0,.35);
    }
    .life.out{background:linear-gradient(135deg, #2b2b2b, #3f3f3f); opacity:.5}

    .game{
      display:grid; grid-template-columns:1.1fr .9fr; gap:16px;
    }

    .board{min-height:460px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)); border:1px dashed var(--glass-bd); border-radius:18px; padding:14px; display:grid; grid-template-rows:auto auto 1fr; gap:10px}
    .board h2{margin:0 0 6px 0}
    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    .dropzone{
      background:var(--panel-2); border:2px dashed rgba(255,255,255,.16); border-radius:14px; padding:10px; min-height:120px; display:flex; flex-direction:column; gap:10px; transition: .15s ease border-color, .15s ease background;
    }
    .dropzone.active{border-color: var(--accent-2); background: rgba(154,209,255,.08)}
    .zone-title{display:flex; align-items:center; justify-content:space-between; gap:6px; color:var(--muted); font-weight:700}
    .zone-total{font-variant-numeric:tabular-nums}

    .bank{background:var(--panel); border:1px solid var(--glass-bd); border-radius:14px; padding:10px; display:flex; flex-wrap:wrap; gap:10px; max-height:300px; overflow:auto}
    .card{
      background:var(--chip); border:1px solid var(--glass-bd); color:var(--chip-ink); padding:10px; border-radius:12px; display:flex; flex-direction:column; gap:6px; width:min(240px, 100%); cursor:grab; box-shadow:var(--shadow-soft); transition:.15s transform ease, .25s box-shadow ease;
    }
    .card:active{cursor:grabbing}
    .card:hover{transform: translateY(-2px); box-shadow:var(--shadow)}
    .card h4{margin:0; font-size:14px}
    .chip-row{display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; color:var(--muted)}
    .amt{font-variant-numeric: tabular-nums; color:var(--ink); font-weight:800}

    .right{
      display:grid; grid-template-rows:auto 1fr; gap:16px
    }

    .question{
      background:var(--panel); border:1px solid var(--glass-bd); border-radius:18px; padding:14px; display:grid; gap:10px
    }
    .question h3{margin:0}
    .options{display:grid; gap:8px}
    .option{
      background:var(--chip); border:1px solid var(--glass-bd); color:var(--chip-ink); border-radius:12px; padding:10px; cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:12px; transition:.15s ease transform, .2s ease background;
    }
    .option:hover{transform: translateY(-1px)}
    .option.correct{outline:2px solid var(--good); background:rgba(52,211,153,.1)}
    .option.wrong{outline:2px solid var(--bad); background:rgba(248,113,113,.1)}

    .actions{display:flex; gap:10px; flex-wrap:wrap}

    .footer{
      display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap
    }
    .kbd{background:#111929; color:#d0d6ff; border:1px solid #263157; padding:2px 8px; border-radius:8px; font-weight:800}

    .pill{padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800}
    .pill.good{background:rgba(52,211,153,.1); color:var(--good); border:1px solid rgba(52,211,153,.35)}
    .pill.bad{background:rgba(248,113,113,.1); color:var(--bad); border:1px solid rgba(248,113,113,.35)}

    /* === Modal / Instrucciones === */
    dialog{ 
      border:none; border-radius:18px; padding:0; width:min(920px, 92vw); background:linear-gradient(180deg, #101538, #0e1534); color:var(--ink);
      box-shadow: var(--shadow);
    }
    .modal{
      padding:18px; display:grid; gap:14px;
    }
    .modal header{justify-content:flex-start}
    .modal h2{margin:0}
    .modal .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .callout{background:var(--chip); border:1px solid var(--glass-bd); border-radius:14px; padding:12px}

    /* Scrollbars */
    *{scrollbar-width:thin; scrollbar-color: #3a4f9c transparent}
    *::-webkit-scrollbar{height:10px; width:10px}
    *::-webkit-scrollbar-thumb{background:#3a4f9c; border-radius:999px}
    *::-webkit-scrollbar-track{background:transparent}

    /* Responsive */
    @media (max-width: 980px){
      .game{grid-template-columns:1fr}
      .hud{grid-template-columns:1fr}
      .modal .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <a href="#" class="brand" aria-label="Inicio">
        <div class="logo" aria-hidden="true">BG</div>
        <div class="title">
          <h1>Balance General Arcade</h1>
          <small>Aprende Activos, Pasivos y Capital con retos arcade üïπÔ∏è</small>
        </div>
      </a>
      <div class="top-actions">
        <button class="btn" id="btnStart">‚ñ∂ Iniciar</button>
        <button class="btn alt" id="btnPractice">üìö Pr√°ctica</button>
        <button class="btn ghost" id="btnHow">‚ùì Instrucciones</button>
      </div>
    </header>

    <section class="hud">
      <div class="panel">
        <div class="scoreboard">
          <span class="tag" title="Puntuaci√≥n actual"><span class="dot"></span> Puntos: <strong id="score">0</strong></span>
          <span class="tag" title="Nivel"><span class="dot" style="background:#ffd38c"></span> Nivel: <strong id="level">1</strong></span>
          <span class="tag" title="Racha de aciertos"><span class="dot" style="background:#34D399"></span> Racha: <strong id="streak">0</strong></span>
          <span class="tag" title="Mejor Puntaje"><span class="dot" style="background:#9ad1ff"></span> R√©cord: <strong id="best">0</strong></span>
        </div>
      </div>
      <div class="panel">
        <div class="progress-wrap">
          <strong>Tiempo</strong>
          <div class="progress" aria-hidden="true"><i id="timebar"></i></div>
          <strong id="timeleft">00</strong>
        </div>
      </div>
      <div class="panel" aria-label="Vidas">
        <div class="lives" id="lives"></div>
      </div>
    </section>

    <main class="game">
      <section class="board panel" aria-label="Tablero">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
          <h2 id="modeTitle">Modo: Clasificaci√≥n Drag & Drop</h2>
          <span class="pill" id="modeBadge">Ronda 1/10</span>
        </div>
        <div class="grid3" id="zones">
          <div class="dropzone" data-zone="activo">
            <div class="zone-title"><span>Activo (A)</span> <span class="zone-total" id="sum-activo">$0</span></div>
            <div class="zone-list" aria-live="polite"></div>
          </div>
          <div class="dropzone" data-zone="pasivo">
            <div class="zone-title"><span>Pasivo (P)</span> <span class="zone-total" id="sum-pasivo">$0</span></div>
            <div class="zone-list" aria-live="polite"></div>
          </div>
          <div class="dropzone" data-zone="capital">
            <div class="zone-title"><span>Capital (C)</span> <span class="zone-total" id="sum-capital">$0</span></div>
            <div class="zone-list" aria-live="polite"></div>
          </div>
        </div>
        <h3 style="margin:8px 0 0 0">Banco de partidas</h3>
        <div class="bank" id="bank" aria-label="Partidas para arrastrar"></div>
      </section>

      <aside class="right">
        <section class="question">
          <h3>Pregunta R√°pida</h3>
          <div id="questionText">Una deuda bancaria a 5 a√±os pertenece a‚Ä¶</div>
          <div class="options" id="options"></div>
          <div class="actions">
            <button class="btn" id="btnCheck">Comprobar</button>
            <button class="btn ghost" id="btnSkip">Saltar</button>
          </div>
          <div id="qFeedback"></div>
        </section>
        <section class="panel">
          <div class="footer">
            <div>
              <span class="pill good">Aciertos: <b id="hits">0</b></span>
              <span class="pill bad">Errores: <b id="fails">0</b></span>
            </div>
            <div>
              <span class="kbd">R</span> Reiniciar &nbsp;|&nbsp; <span class="kbd">H</span> Ayuda &nbsp;|&nbsp; <span class="kbd">M</span> Cambiar modo
            </div>
          </div>
        </section>
      </aside>
    </main>

    <footer style="opacity:.8; font-size:12px; text-align:center">Hecho para practicar Balance General (A = P + C). Guarda progreso localmente. ¬© 2025</footer>
  </div>

  <!-- ===== INSTRUCCIONES / MODAL ===== -->
  <dialog id="dlgHow">
    <div class="modal">
      <header>
        <div class="logo" aria-hidden="true">BG</div>
        <div>
          <h2>C√≥mo jugar ‚Äî Balance General Arcade</h2>
          <small>Objetivo: completar retos y mantener el balance A = P + C</small>
        </div>
      </header>
      <div class="grid">
        <div class="callout">
          <h3>üéØ Modos de juego</h3>
          <ul>
            <li><b>Clasificaci√≥n (Drag & Drop):</b> Arrastra partidas al bloque correcto (Activo, Pasivo, Capital). Suma de cada bloque se calcula en tiempo real.</li>
            <li><b>Constructor del Balance:</b> Recibe transacciones. Elige d√≥nde afectan y con qu√© signo hasta cuadrar <i>A = P + C</i>.</li>
            <li><b>Reto Rel√°mpago:</b> Preguntas de opci√≥n m√∫ltiple con temporizador. Racha = bonificaci√≥n.</li>
          </ul>
        </div>
        <div class="callout">
          <h3>‚å®Ô∏è Controles</h3>
          <ul>
            <li><span class="kbd">R</span> Reiniciar nivel</li>
            <li><span class="kbd">M</span> Cambiar modo</li>
            <li><span class="kbd">H</span> Abrir esta ayuda</li>
            <li>Arrastra tarjetas desde el banco hacia las zonas de A, P o C</li>
          </ul>
        </div>
        <div class="callout">
          <h3>üèÜ Puntuaci√≥n & Vidas</h3>
          <ul>
            <li>Acierto +10, Racha +5 extra cada 3 aciertos.</li>
            <li>Error ‚àí5 y pierdes una vida. 3 vidas por nivel.</li>
            <li>Completa 10 rondas para subir de nivel (m√°s √≠tems, menos tiempo).</li>
          </ul>
        </div>
        <div class="callout">
          <h3>üíæ Progreso</h3>
          <ul>
            <li>Se guarda autom√°ticamente (puntos y r√©cord) en tu navegador.</li>
            <li>Modo Pr√°ctica no resta vidas ni tiene tiempo.</li>
          </ul>
        </div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:6px">
        <button class="btn ghost" id="btnCloseHow">Cerrar</button>
        <button class="btn" id="btnStartFromHow">Jugar ahora</button>
      </div>
    </div>
  </dialog>

  <!-- ===== SONIDOS (WebAudio) ===== -->
  <script>
  // =========================================================
  // Audio minimalista con WebAudio API (sin archivos externos)
  // =========================================================
  const AudioFX = (()=>{
    let ctx;
    const ensure = ()=>{ if(!ctx){ ctx = new (window.AudioContext || window.webkitAudioContext)(); } return ctx };
    const play = (type='sine', freq=440, dur=0.08, vol=0.05, when=0)=>{
      const c = ensure();
      const o = c.createOscillator();
      const g = c.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = vol; o.connect(g); g.connect(c.destination);
      const t = c.currentTime + when;
      o.start(t); o.stop(t + dur);
      // peque√±o fade
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(vol, t + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
    };
    return {
      ok:()=>{ play('triangle', 660, 0.09, 0.06); play('triangle', 990, 0.07, 0.05, 0.05) },
      bad:()=>{ play('sawtooth', 160, 0.12, 0.06); },
      tick:()=>{ play('sine', 880, 0.03, 0.03) },
      level:()=>{ play('square', 320, 0.09, 0.06); play('square', 640, 0.09, 0.05, 0.05); play('square', 960, 0.09, 0.04, 0.10) }
    }
  })();
  </script>

  <!-- ===== L√ìGICA DEL JUEGO ===== -->
  <script>
  // =========================================================
  // BALANCE GENERAL ARCADE ‚Äî L√ìGICA PRINCIPAL
  // Autor: NEXTSKILL (2025)
  // =========================================================

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const ui = {
    score: $('#score'), level: $('#level'), streak: $('#streak'), best: $('#best'),
    timebar: $('#timebar'), timeleft: $('#timeleft'), lives: $('#lives'),
    bank: $('#bank'), zones: $('#zones'), modeTitle: $('#modeTitle'), modeBadge: $('#modeBadge'),
    qText: $('#questionText'), opts: $('#options'), qFeedback: $('#qFeedback'),
    hits: $('#hits'), fails: $('#fails')
  };

  const btn = {
    start: $('#btnStart'), practice: $('#btnPractice'), how: $('#btnHow'),
    check: $('#btnCheck'), skip: $('#btnSkip'), closeHow: $('#btnCloseHow'), startFromHow: $('#btnStartFromHow')
  };

  const dlgHow = $('#dlgHow');

  // ======= Datos base (partidas + preguntas) =======
  // Partidas (nombre, monto, clave correcta: 'activo' | 'pasivo' | 'capital', subclasificaci√≥n)
  const PARTIDAS = [
    {n:'Caja y Bancos', m: 12000, z:'activo', sub:'Circulante'},
    {n:'Cuentas por Cobrar (90 d√≠as)', m: 18000, z:'activo', sub:'Circulante'},
    {n:'Inventarios', m: 15000, z:'activo', sub:'Circulante'},
    {n:'Propiedad, Planta y Equipo', m: 90000, z:'activo', sub:'No Circulante'},
    {n:'Depreciaci√≥n Acumulada (‚àí)', m: -8000, z:'activo', sub:'No Circulante'},
    {n:'Gastos Pagados por Anticipado', m: 4000, z:'activo', sub:'Circulante'},
    {n:'Clientes Incobrables (estimaci√≥n ‚àí)', m: -1200, z:'activo', sub:'Circulante'},

    {n:'Proveedores', m: 10000, z:'pasivo', sub:'Corto Plazo'},
    {n:'Documentos por Pagar a 2 a√±os', m: 14000, z:'pasivo', sub:'Largo Plazo'},
    {n:'Impuestos por Pagar', m: 3000, z:'pasivo', sub:'Corto Plazo'},
    {n:'Acreedores Diversos', m: 4500, z:'pasivo', sub:'Corto Plazo'},
    {n:'Cr√©dito Bancario 5 a√±os', m: 22000, z:'pasivo', sub:'Largo Plazo'},

    {n:'Capital Social', m: 50000, z:'capital', sub:'Contribuido'},
    {n:'Utilidades Retenidas', m: 12000, z:'capital', sub:'Ganado'},
    {n:'Resultado del Ejercicio', m: 6500, z:'capital', sub:'Ganado'}
  ];

  // Preguntas tipo test (texto, opciones[], correcta)
  const PREGUNTAS = [
    {t:'Una deuda bancaria a 5 a√±os pertenece a‚Ä¶', o:['Pasivo a Corto Plazo','Pasivo a Largo Plazo','Activo No Circulante','Capital Ganado'], c:1},
    {t:'La f√≥rmula del Balance General es‚Ä¶', o:['A + P = C','A = P + C','A + C = P','P = A + C'], c:1},
    {t:'La ‚ÄúDepreciaci√≥n Acumulada‚Äù se presenta en‚Ä¶', o:['Activo con signo positivo','Pasivo a Corto Plazo','Reducci√≥n de activo (signo ‚àí)','Capital Social'], c:2},
    {t:'‚ÄúCaja y Bancos‚Äù es un‚Ä¶', o:['Activo Circulante','Pasivo a Corto Plazo','Capital Contribuido','Gasto'], c:0},
    {t:'‚ÄúUtilidades Retenidas‚Äù pertenece a‚Ä¶', o:['Pasivo Largo Plazo','Capital Ganado','Activo No Circulante','Gasto'], c:1},
    {t:'Los ‚ÄúProveedores‚Äù se clasifican como‚Ä¶', o:['Activo Circulante','Pasivo a Corto Plazo','Capital Social','Ingreso'], c:1},
    {t:'‚ÄúInventarios‚Äù pertenece a‚Ä¶', o:['Activo Circulante','Pasivo a Largo Plazo','Activo No Circulante','Capital Ganado'], c:0},
    {t:'Si A = 100 y P = 40, entonces C = ‚Ä¶', o:['60','140','40','100'], c:0},
    {t:'Los gastos pagados por anticipado son‚Ä¶', o:['Activo','Pasivo','Capital','Ingreso'], c:0},
    {t:'La cuenta que reduce ‚ÄúClientes‚Äù por incobrables es‚Ä¶', o:['Provisi√≥n de Deudores','Acreedores Diversos','Inventarios','Capital Social'], c:0}
  ];

  // Transacciones para el modo Constructor (descripci√≥n, efecto: arreglo de {zona, monto})
  const TRANS = [
    {d:'Compra de inventario al contado por $3,000', e:[{z:'activo', m:3000}, {z:'activo', m:-3000}]},
    {d:'Pago a proveedores $2,000', e:[{z:'pasivo', m:-2000}, {z:'activo', m:-2000}]},
    {d:'Pr√©stamo bancario a 3 a√±os por $10,000 (entra a bancos)', e:[{z:'pasivo', m:10000}, {z:'activo', m:10000}]},
    {d:'Ajuste depreciaci√≥n del periodo $1,200', e:[{z:'activo', m:-1200}, {z:'capital', m:-1200}]},
    {d:'Venta al contado $4,500 con costo $2,000', e:[{z:'activo', m:4500}, {z:'capital', m:2500}, {z:'activo', m:-2000}]},
    {d:'Emisi√≥n de capital por $8,000, entra a bancos', e:[{z:'capital', m:8000}, {z:'activo', m:8000}]},
    {d:'Pago de impuestos $900', e:[{z:'activo', m:-900}, {z:'capital', m:-900}]},
    {d:'Compra de equipo con cr√©dito bancario $12,000', e:[{z:'activo', m:12000}, {z:'pasivo', m:12000}]},
  ];

  // ======= Estado del juego =======
  const state = {
    mode: 0, // 0: DragDrop, 1: Constructor, 2: Rel√°mpago
    level: 1, round: 1, maxRounds: 10,
    score: 0, streak: 0, hits: 0, fails: 0, lives: 3,
    practice: false,
    time: 60, timeMax: 60, timer: null,
    bank: [], placed: {activo:[], pasivo:[], capital:[]},
    qIndex: 0, chosen: null,
    build: {ledger: {activo:0, pasivo:0, capital:0}, step:0, trans: null}
  };

  // ======= Utilidades =======
  const fmt = n => {
    const s = n < 0 ? '-' : '';
    const x = Math.abs(n).toLocaleString('es-MX');
    return s + '$' + x;
  };
  const rand = (min, max) => Math.floor(Math.random()*(max-min+1))+min;
  const shuffle = arr => [...arr].sort(()=>Math.random()-0.5);

  function save(){
    const best = parseInt(localStorage.getItem('bg_best')||'0',10);
    if(state.score>best){ localStorage.setItem('bg_best', String(state.score)) }
    ui.best.textContent = localStorage.getItem('bg_best') || '0';
  }
  function load(){ ui.best.textContent = localStorage.getItem('bg_best') || '0'; }

  // ======= Render de HUD =======
  function renderHUD(){
    ui.score.textContent = state.score;
    ui.level.textContent = state.level;
    ui.streak.textContent = state.streak;
    ui.hits.textContent = state.hits;
    ui.fails.textContent = state.fails;
    ui.modeBadge.textContent = `Ronda ${state.round}/${state.maxRounds}`;

    ui.lives.innerHTML = '';
    for(let i=0;i<3;i++){
      const d = document.createElement('div'); d.className = 'life' + (i<state.lives?'':' out');
      ui.lives.appendChild(d);
    }
  }

  function setTime(t){
    state.time = Math.max(0, Math.min(t, state.timeMax));
    ui.timeleft.textContent = String(state.time).padStart(2,'0');
    const pct = (state.time/state.timeMax)*100; ui.timebar.style.width = pct + '%';
  }

  function startTimer(){
    if(state.practice){ setTime(state.timeMax); return }
    stopTimer(); setTime(state.timeMax);
    state.timer = setInterval(()=>{
      setTime(state.time-1);
      if(state.time<=0){
        loseLife('‚è±Ô∏è Tiempo agotado');
      } else if(state.time<=5){ AudioFX.tick() }
    }, 1000);
  }
  function stopTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null } }

  // ======= Inicializar partida =======
  function resetRound(){
    state.round = 1; state.level = 1; state.lives = 3; state.hits = 0; state.fails = 0; state.streak=0; state.score=0; state.practice=false;
    nextRound(true);
  }

  function nextRound(first=false){
    // Aumentar dificultad por nivel
    const baseTime = 60; const timeDec = Math.min(35, (state.level-1)*5);
    state.timeMax = baseTime - timeDec; if(state.practice) state.timeMax = 9999;
    setTime(state.timeMax);

    // Selecci√≥n de modo rotativo: 0 -> 1 -> 2 -> 0 ‚Ä¶
    if(!first){ state.mode = (state.mode+1)%3; }
    renderModeTitle();

    // Configurar elementos seg√∫n modo
    if(state.mode===0){ setupDragDrop(); }
    if(state.mode===1){ setupBuilder(); }
    if(state.mode===2){ setupQuiz(); }

    startTimer(); renderHUD();
  }

  function renderModeTitle(){
    const names = ['Clasificaci√≥n Drag & Drop','Constructor del Balance','Reto Rel√°mpago'];
    ui.modeTitle.textContent = 'Modo: ' + names[state.mode];
  }

  // ======= MODO 0: CLASIFICACI√ìN DRAG & DROP =======
  function setupDragDrop(){
    // limpiar zonas
    state.bank = []; state.placed = {activo:[], pasivo:[], capital:[]};
    $$('#sum-activo, #sum-pasivo, #sum-capital').forEach(el=> el.textContent = '$0');
    $$('.zone-list').forEach(z=> z.innerHTML='');

    const n = 5 + Math.min(5, state.level); // √≠tems crecientes con nivel
    state.bank = shuffle(PARTIDAS).slice(0, n);

    renderBank();

    // preparar dropzones
    $$('.dropzone').forEach(z=>{
      z.addEventListener('dragover', e=>{ e.preventDefault(); z.classList.add('active');});
      z.addEventListener('dragleave', ()=> z.classList.remove('active'));
      z.addEventListener('drop', e=>{
        e.preventDefault(); z.classList.remove('active');
        const id = e.dataTransfer.getData('text/plain');
        const item = state.bank.find(x=> x.id === id);
        if(!item) return; // ya colocado
        const correct = z.dataset.zone === item.z;
        placeCard(item, z.dataset.zone, correct);
      })
    });
  }

  function renderBank(){
    ui.bank.innerHTML = '';
    state.bank.forEach((it, idx)=>{
      it.id = it.id || `p_${Math.random().toString(36).slice(2)}`;
      const d = document.createElement('div'); d.className='card'; d.draggable=true; d.id = it.id;
      d.innerHTML = `<h4>${it.n}</h4>
        <div class="chip-row"><span>${it.sub}</span><span class="amt">${fmt(it.m)}</span></div>`;
      d.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', it.id);
      });
      ui.bank.appendChild(d);
    });
  }

  function placeCard(item, zone, correct){
    // quitar del banco
    state.bank = state.bank.filter(x=> x.id!==item.id);
    const target = $(`.dropzone[data-zone="${zone}"] .zone-list`);
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<h4>${item.n}</h4><div class="chip-row"><span>${item.sub}</span><span class="amt">${fmt(item.m)}</span></div>`;
    target.appendChild(card);

    // sumar si correcto, si no regresar al banco y penalizar
    if(correct){
      state.placed[zone].push(item); addScore(10); addStreak(); AudioFX.ok();
    }else{
      addScore(-5); resetStreak(); loseLife('‚ùå Clasificaci√≥n incorrecta'); AudioFX.bad();
      // devolver el √≠tem al banco
      setTimeout(()=>{ state.bank.push(item); renderBank(); }, 350);
    }

    recalcSums();

    // si ya no hay en banco, ronda completa
    if(state.bank.length===0){
      roundComplete();
    }
  }

  function recalcSums(){
    const sumA = state.placed.activo.reduce((a,b)=>a+b.m,0);
    const sumP = state.placed.pasivo.reduce((a,b)=>a+b.m,0);
    const sumC = state.placed.capital.reduce((a,b)=>a+b.m,0);
    $('#sum-activo').textContent = fmt(sumA);
    $('#sum-pasivo').textContent = fmt(sumP);
    $('#sum-capital').textContent = fmt(sumC);
  }

  // ======= MODO 1: CONSTRUCTOR DEL BALANCE =======
  function setupBuilder(){
    // limpiar tablero y generar una transacci√≥n
    $$('.zone-list').forEach(z=> z.innerHTML='');
    $$('#sum-activo, #sum-pasivo, #sum-capital').forEach(el=> el.textContent = '$0');
    ui.bank.innerHTML = '';

    state.build.ledger = {activo:0, pasivo:0, capital:0};
    state.build.step = 0;
    state.build.trans = TRANS[rand(0, TRANS.length-1)];

    const d = document.createElement('div'); d.className='card';
    d.innerHTML = `<h4>Transacci√≥n</h4><div class="chip-row"><span>${state.build.trans.d}</span><span class="amt">&nbsp;</span></div>`;
    ui.bank.appendChild(d);

    // crear 6 botones de efecto: +A, ‚àíA, +P, ‚àíP, +C, ‚àíC
    const effects = [
      {k:'+A', z:'activo', s:1}, {k:'‚àíA', z:'activo', s:-1},
      {k:'+P', z:'pasivo', s:1}, {k:'‚àíP', z:'pasivo', s:-1},
      {k:'+C', z:'capital', s:1}, {k:'‚àíC', z:'capital', s:-1}
    ];
    const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.flexWrap='wrap'; wrap.style.gap='8px'; wrap.style.marginTop='8px';
    effects.forEach(eff=>{
      const b = document.createElement('button'); b.className='btn ghost'; b.textContent = eff.k;
      b.addEventListener('click', ()=> applyEffect(eff)); wrap.appendChild(b);
    });
    ui.bank.appendChild(wrap);

    // indicador de balance
    const ind = document.createElement('div'); ind.style.marginTop='8px'; ind.innerHTML = `<span class="pill">A: <b id="bA">$0</b></span> <span class="pill">P: <b id="bP">$0</b></span> <span class="pill">C: <b id="bC">$0</b></span> <span class="pill" id="bOK">¬øA = P + C?</span>`;
    ui.bank.appendChild(ind);

    // controles de cantidad
    const ctl = document.createElement('div'); ctl.style.marginTop='8px';
    ctl.innerHTML = `<div class="card" style="cursor:auto"><h4>Monto</h4><div class="chip-row"><input id="bAmt" type="number" value="0" style="width:140px; padding:6px; border-radius:10px; border:1px solid var(--glass-bd); background:var(--panel-2); color:var(--ink)"><span><button class='btn' id='bAdd'>Aplicar</button></span></div></div>`;
    ui.bank.appendChild(ctl);

    $('#bAdd').addEventListener('click', ()=>{
      const v = parseFloat($('#bAmt').value||'0');
      if(!v) return;
      // aplicar al √∫ltimo bot√≥n presionado (guardar en memoria)
      if(lastEffect){ applyEffect({...lastEffect}, v) }
    });
  }

  let lastEffect = null;
  function applyEffect(eff, amount=null){
    lastEffect = eff;
    const v = amount===null ? Math.abs(rand(500, 5000)) : Math.abs(amount);
    state.build.ledger[eff.z] += eff.s * v;
    updateBuilderUI();

    // ver si coincide con alguno de los efectos reales (tolerancia por orden)
    const step = state.build.step;
    const trans = state.build.trans;
    const exp = trans.e[step];
    if(!exp) return; // no m√°s pasos

    const ok = (eff.z === exp.z) && (eff.s === Math.sign(exp.m)) && (v === Math.abs(exp.m));
    if(ok){
      state.build.step++;
      addScore(12); addStreak(); AudioFX.ok();
      if(state.build.step>=trans.e.length){
        // todas las partes aplicadas ‚Äî ronda lista si cuadra el balance
        const a = state.build.ledger.activo; const p = state.build.ledger.pasivo; const c = state.build.ledger.capital;
        if(a === (p + c)){
          roundComplete();
        } else {
          // a√∫n no cuadra ‚Äî breve hint
          hint(`üí° Falta cuadrar: A=${fmt(a)} | P+C=${fmt(p+c)}`);
        }
      }
    }else{
      addScore(-6); resetStreak(); loseLife('‚ùå Efecto incorrecto'); AudioFX.bad();
    }
  }

  function updateBuilderUI(){
    $('#bA').textContent = fmt(state.build.ledger.activo);
    $('#bP').textContent = fmt(state.build.ledger.pasivo);
    $('#bC').textContent = fmt(state.build.ledger.capital);
    const ok = state.build.ledger.activo === (state.build.ledger.pasivo + state.build.ledger.capital);
    $('#bOK').textContent = ok ? '‚úÖ ¬°Balanceado!' : '‚ùì ¬øA = P + C?';
  }

  // ======= MODO 2: RETO REL√ÅMPAGO (QUIZ) =======
  function setupQuiz(){
    state.qIndex = 0; renderQuestion();
  }

  function renderQuestion(){
    const q = PREGUNTAS[state.qIndex % PREGUNTAS.length];
    ui.qText.textContent = q.t;
    ui.opts.innerHTML = '';
    q.o.forEach((txt, i)=>{
      const d = document.createElement('div'); d.className='option'; d.innerHTML = `<span>${txt}</span><span class='amt'>${i+1}</span>`;
      d.addEventListener('click', ()=> selectOption(i));
      ui.opts.appendChild(d);
    });
    ui.qFeedback.innerHTML = '';
    state.chosen = null;
  }

  function selectOption(i){
    state.chosen = i;
    $$('.option').forEach((el, idx)=>{
      el.classList.toggle('correct', idx===i); // resaltado de selecci√≥n
    });
  }

  btn.check.addEventListener('click', ()=>{
    const q = PREGUNTAS[state.qIndex % PREGUNTAS.length];
    if(state.chosen===null){ hint('Selecciona una opci√≥n.'); return }
    const opts = $$('.option');
    opts.forEach((el, idx)=>{
      el.classList.remove('correct'); el.classList.remove('wrong');
      if(idx===q.c){ el.classList.add('correct') }
      if(idx===state.chosen && state.chosen!==q.c){ el.classList.add('wrong') }
    });
    if(state.chosen===q.c){ addScore(8); addStreak(); state.hits++; ui.qFeedback.innerHTML = '<span class="pill good">Correcto</span>'; AudioFX.ok(); }
    else { addScore(-4); resetStreak(); state.fails++; ui.qFeedback.innerHTML = '<span class="pill bad">Incorrecto</span>'; loseLife('‚ùå Respuesta incorrecta'); AudioFX.bad(); }
    renderHUD();
    state.qIndex++;
    setTimeout(()=>{ renderQuestion(); }, 800);
  });
  btn.skip.addEventListener('click', ()=>{ state.qIndex++; renderQuestion(); });

  // ======= Puntuaci√≥n / vidas =======
  function addScore(n){ state.score = Math.max(0, state.score + n); ui.score.textContent = state.score; save(); }
  function addStreak(){ state.streak++; ui.streak.textContent = state.streak; if(state.streak>0 && state.streak%3===0){ addScore(5); hint('üî• Bonificaci√≥n por racha +5'); } }
  function resetStreak(){ state.streak = 0; ui.streak.textContent = 0; }

  function loseLife(reason=''){ if(state.practice) return; state.lives--; renderHUD(); if(reason) hint(reason); if(state.lives<=0){ gameOver(); } }

  function roundComplete(){
    stopTimer(); state.hits++; addScore(20); AudioFX.level();
    hint('‚úÖ Ronda completa');
    if(state.round>=state.maxRounds){
      // subir nivel
      state.level++; state.round = 1; state.lives=3; hint(`‚¨ÜÔ∏è Nivel ${state.level}`);
    } else {
      state.round++;
    }
    renderHUD();
    setTimeout(()=> nextRound(), 650);
  }

  function gameOver(){
    stopTimer(); hint(`üíÄ Game Over | Puntaje: ${state.score}`);
    // reset tras breve pausa
    setTimeout(resetRound, 1200);
  }

  // ======= Mensajes / hints =======
  let hintTO = null;
  function hint(msg){
    clearTimeout(hintTO);
    const el = document.createElement('div');
    el.className = 'tag'; el.style.position='fixed'; el.style.left='50%'; el.style.bottom='24px'; el.style.transform='translateX(-50%)'; el.style.zIndex='9999';
    el.style.background='linear-gradient(135deg, #1f2d66, #253581)'; el.style.boxShadow='var(--shadow)';
    el.innerHTML = `<span class="dot"></span>${msg}`;
    document.body.appendChild(el);
    hintTO = setTimeout(()=>{ el.remove() }, 1600);
  }

  // ======= Hotkeys =======
  window.addEventListener('keydown', (e)=>{
    if(e.key==='r' || e.key==='R'){ e.preventDefault(); nextRound(true) }
    if(e.key==='h' || e.key==='H'){ e.preventDefault(); openHow() }
    if(e.key==='m' || e.key==='M'){ e.preventDefault(); state.mode=(state.mode+1)%3; renderModeTitle(); if(state.mode===0) setupDragDrop(); if(state.mode===1) setupBuilder(); if(state.mode===2) setupQuiz(); startTimer(); }
  });

  // ======= Botones principales =======
  btn.start.addEventListener('click', ()=>{ state.practice=false; resetRound(); });
  btn.practice.addEventListener('click', ()=>{ state.practice=true; resetRound(); });

  function openHow(){ dlgHow.showModal(); }
  function closeHow(){ dlgHow.close(); }
  btn.how.addEventListener('click', openHow);
  btn.closeHow.addEventListener('click', closeHow);
  btn.startFromHow.addEventListener('click', ()=>{ closeHow(); state.practice=false; resetRound(); });

  // ======= Inicio =======
  load(); renderHUD(); openHow();
  </script>

  <!-- ============================================================
       L√çNEAS EXTRA DE CONTENIDO COMENTADO PARA DOCUMENTAR EL C√ìDIGO
       (Mantienen el archivo > 800 l√≠neas sin afectar rendimiento)
       A partir de aqu√≠ encontrar√°s una gu√≠a r√°pida de estudio.
       ============================================================ -->
  <script>
  /*
  =================== GUIA R√ÅPIDA DE BALANCE GENERAL ===================
  1) Estructura b√°sica:
     - Activo (A): Recursos controlados (Caja, Bancos, Clientes, Inventarios, PPE)
     - Pasivo (P): Obligaciones presentes (Proveedores, Bancos, Impuestos por pagar)
     - Capital (C): Patrimonio de los due√±os (Capital Social, Utilidades Retenidas)
     F√≥rmula: A = P + C

  2) Clasificaci√≥n de Activo:
     a) Circulante: caja, bancos, clientes (‚â§ 1 a√±o), inventarios, anticipos
     b) No circulante: propiedades, maquinaria y equipo (menos depreciaci√≥n), intangibles

  3) Clasificaci√≥n de Pasivo:
     a) Corto plazo: proveedores, impuestos por pagar, documentos a ‚â§ 1 a√±o
     b) Largo plazo: cr√©ditos a m√°s de un a√±o

  4) Capital:
     a) Contribuido: aportaciones de socios (Capital Social, Prima en emisi√≥n)
     b) Ganado: utilidades retenidas, resultado del ejercicio

  5) Se√±ales frecuentes de error:
     - Colocar depreciaci√≥n acumulada como pasivo. En realidad es una cuenta correctiva de activo (signo negativo).
     - Confundir gastos pagados por anticipado (ACTIVO) con gastos del periodo.
     - Incluir ventas o gastos en el balance (van en estado de resultados). S√≥lo su efecto neto en capital.

  6) Reglas del modo Constructor:
     - Cada transacci√≥n tiene efectos duales o m√∫ltiples. Reproducirlos con los botones +A/‚àíA/+P/‚àíP/+C/‚àíC y el monto exacto.
     - Al finalizar, verificar que A = P + C. Si no, revisar montos o signos.

  7) Sugerencias de estudio:
     - Practica con casos: compra de inventario, pr√©stamo, pago a proveedores, ajuste de depreciaci√≥n.
     - Dibuja T-accounts simples mentalmente para entender los signos.
     - Revisa la consistencia matem√°tica despu√©s de cada movimiento.

  ¬°√âxitos! Sigue practicando hasta dominarlo. 
  */
  </script>
</body>
</html>

