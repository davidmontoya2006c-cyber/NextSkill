<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üìä Balance General Arcade ‚Äî NextSkill</title>
<style>
:root{
  --bg:#050816;
  --panel:#0b1026;
  --panel2:#111936;
  --glass:#141b3a;
  --bd:rgba(255,255,255,.14);
  --ink:#eef2ff;
  --muted:#9ca6e5;
  --accent:#7c9cff;
  --accent2:#9ad1ff;
  --good:#34d399;
  --bad:#f87171;
  --warn:#facc15;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:"Inter",system-ui,Segoe UI,Roboto,sans-serif}
body{
  background:
    radial-gradient(900px 600px at 0% 0%, #1a237e 0%, transparent 60%),
    radial-gradient(900px 600px at 120% 0%, #0f172a 0%, transparent 60%),
    linear-gradient(#020617,#020617);
  color:var(--ink);
}
.app{min-height:100vh;padding:18px;display:grid;grid-template-rows:auto auto 1fr auto;gap:16px}

/* HEADER */
header{display:flex;justify-content:space-between;align-items:center;gap:16px}
.brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--ink)}
.logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#7c9cff,#9ad1ff);display:grid;place-items:center;font-weight:900;color:#020617;box-shadow:0 8px 24px rgba(15,23,42,.6)}
.title h1{margin:0;font-size:clamp(18px,2.6vw,26px)}
.title small{color:var(--muted);font-size:13px}
.top-actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{
  border:none;border-radius:12px;padding:9px 14px;font-weight:700;cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--accent2));color:#020617;
  box-shadow:0 8px 24px rgba(15,23,42,.7);transition:.15s transform,.15s box-shadow;
}
.btn:hover{transform:translateY(-1px);box-shadow:0 12px 32px rgba(15,23,42,.9)}
.btn:active{transform:translateY(0);box-shadow:0 6px 18px rgba(15,23,42,.7)}
.btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--bd);box-shadow:none}
.btn.alt{background:linear-gradient(135deg,#fbbf24,#f97316);color:#111827}

/* HUD */
.hud{display:grid;grid-template-columns:2fr 1fr 1fr;gap:14px}
.panel{
  background:var(--panel);border-radius:16px;padding:12px;border:1px solid var(--bd);
  box-shadow:0 6px 18px rgba(15,23,42,.7);
}
.score-row{display:flex;flex-wrap:wrap;gap:8px}
.tag{
  padding:7px 10px;border-radius:999px;border:1px solid var(--bd);
  background:var(--glass);font-size:12px;display:flex;align-items:center;gap:7px;
}
.dot{width:8px;height:8px;border-radius:999px;background:#4ade80}
.tag strong{font-size:13px}
.progress-wrap{display:flex;align-items:center;gap:10px}
.progress{flex:1;height:9px;border-radius:999px;background:#020617;border:1px solid var(--bd);overflow:hidden}
.progress span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#7c9cff,#22c55e)}
#timeleft{font-variant-numeric:tabular-nums}
.lives{display:flex;gap:5px}
.life{
  width:18px;height:18px;border-radius:6px;
  background:radial-gradient(circle at 30% 25%,#fecaca 0,#f97373 35%,#b91c1c 70%);
  border:1px solid rgba(248,113,113,.9);
}
.life.out{background:#111827;border-color:#4b5563;opacity:.5}

/* MAIN LAYOUT */
.main{display:grid;grid-template-columns:1.3fr 1fr;gap:16px}
.board{
  background:var(--panel2);border-radius:18px;padding:14px;border:1px solid var(--bd);
  display:grid;grid-template-rows:auto auto 1fr;gap:10px;
}
.board-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
.badge{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--bd);color:var(--muted)}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.dropzone{
  background:#020617;border-radius:14px;border:2px dashed rgba(148,163,184,.5);
  padding:10px;display:flex;flex-direction:column;gap:8px;min-height:120px;
  transition:.15s border-color,.15s background;
}
.dropzone.active{border-color:#38bdf8;background:rgba(56,189,248,.06)}
.zone-head{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--muted);font-weight:600}
.zone-total{font-variant-numeric:tabular-nums}
.bank-title{font-size:13px;color:var(--muted);margin-top:2px}
.bank{
  margin-top:4px;background:#020617;border-radius:12px;border:1px solid var(--bd);
  padding:8px;display:flex;flex-wrap:wrap;gap:8px;max-height:220px;overflow:auto;
}
.card-item{
  background:var(--glass);border-radius:12px;border:1px solid var(--bd);
  padding:8px 9px;min-width:180px;max-width:220px;cursor:grab;
  box-shadow:0 6px 16px rgba(15,23,42,.8);transition:.15s transform,.15s box-shadow;
}
.card-item:active{cursor:grabbing}
.card-item:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(15,23,42,1)}
.card-item h4{margin:0;font-size:13px}
.card-meta{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--muted);margin-top:4px}
.card-amt{font-weight:700;color:var(--ink);font-variant-numeric:tabular-nums}

/* RIGHT SIDE: QUIZ */
.side{display:grid;grid-template-rows:1.4fr auto;gap:12px}
.quiz{
  background:var(--panel2);border-radius:16px;border:1px solid var(--bd);
  padding:12px;display:grid;gap:10px;
}
.quiz h3{margin:0;font-size:16px}
.quiz-question{font-size:14px;color:#e5e7eb;min-height:40px}
.options{display:grid;gap:7px}
.option{
  background:var(--glass);border-radius:12px;border:1px solid var(--bd);
  padding:8px 10px;font-size:13px;display:flex;justify-content:space-between;align-items:center;
  cursor:pointer;transition:.15s transform,.15s background,.15s border-color;
}
.option span:last-child{opacity:.7;font-size:11px}
.option:hover{transform:translateY(-1px);background:#020617}
.option.selected{border-color:#38bdf8;background:rgba(56,189,248,.08)}
.option.correct{border-color:var(--good);background:rgba(34,197,94,.1)}
.option.wrong{border-color:var(--bad);background:rgba(248,113,113,.1)}
.quiz-actions{display:flex;gap:8px;flex-wrap:wrap}
.feedback{min-height:20px;font-size:12px}
.feedback.good{color:var(--good)}
.feedback.bad{color:var(--bad)}

.stats{
  background:var(--panel2);border-radius:16px;border:1px solid var(--bd);
  padding:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;
}
.pill{padding:5px 9px;border-radius:999px;font-size:12px;border:1px solid var(--bd)}
.pill.good{background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.6);color:var(--good)}
.pill.bad{background:rgba(248,113,113,.08);border-color:rgba(248,113,113,.6);color:var(--bad)}
.kbd{padding:2px 7px;border-radius:7px;font-size:11px;border:1px solid #4b5563;background:#020617;color:#e5e7eb}

footer{font-size:11px;color:var(--muted);text-align:center;margin-top:4px}

/* TOAST */
.toast{
  position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
  background:#020617;border-radius:999px;border:1px solid var(--bd);
  padding:6px 14px;font-size:12px;display:none;align-items:center;gap:8px;
  box-shadow:0 10px 30px rgba(15,23,42,1);z-index:50;
}
.toast.show{display:flex}

/* RESPONSIVE */
@media(max-width:900px){
  .hud{grid-template-columns:1fr}
  .main{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header>
    <a href="#" class="brand">
      <div class="logo">BG</div>
      <div class="title">
        <h1>Balance General Arcade</h1>
        <small>Arrastra partidas a Activo, Pasivo y Capital. A = P + C üß†</small>
      </div>
    </a>
    <div class="top-actions">
      <button class="btn" id="btnStart">‚ñ∂ Iniciar juego</button>
      <button class="btn alt" id="btnPractice">üéì Modo pr√°ctica</button>
      <button class="btn ghost" id="btnHelp">‚ùî Ayuda r√°pida</button>
    </div>
  </header>

  <!-- HUD -->
  <section class="hud">
    <div class="panel">
      <div class="score-row">
        <div class="tag"><span class="dot"></span> Puntos: <strong id="score">0</strong></div>
        <div class="tag"><span class="dot" style="background:#fbbf24"></span> Racha: <strong id="streak">0</strong></div>
        <div class="tag"><span class="dot" style="background:#22c55e"></span> Ronda: <strong id="round">1</strong>/10</div>
        <div class="tag"><span class="dot" style="background:#38bdf8"></span> R√©cord: <strong id="best">0</strong></div>
      </div>
    </div>
    <div class="panel">
      <div class="progress-wrap">
        <strong style="font-size:13px">Tiempo</strong>
        <div class="progress"><span id="timebar"></span></div>
        <strong id="timeleft">60</strong>
      </div>
    </div>
    <div class="panel">
      <div class="lives" id="lives"></div>
    </div>
  </section>

  <!-- MAIN -->
  <section class="main">
    <!-- TABLERO -->
    <section class="board" aria-label="Tablero de balance general">
      <div class="board-top">
        <h2 style="font-size:17px">Clasifica las partidas</h2>
        <span class="badge" id="modeTag">Modo: Arcade</span>
      </div>

      <div class="grid3" id="zones">
        <div class="dropzone" data-zone="activo">
          <div class="zone-head">
            <span>Activo (A)</span>
            <span class="zone-total" id="sum-activo">$0</span>
          </div>
          <div class="zone-list"></div>
        </div>
        <div class="dropzone" data-zone="pasivo">
          <div class="zone-head">
            <span>Pasivo (P)</span>
            <span class="zone-total" id="sum-pasivo">$0</span>
          </div>
          <div class="zone-list"></div>
        </div>
        <div class="dropzone" data-zone="capital">
          <div class="zone-head">
            <span>Capital (C)</span>
            <span class="zone-total" id="sum-capital">$0</span>
          </div>
          <div class="zone-list"></div>
        </div>
      </div>

      <div>
        <div class="bank-title">Banco de partidas (arrastra a la columna correcta)</div>
        <div class="bank" id="bank"></div>
      </div>
    </section>

    <!-- LADO DERECHO -->
    <aside class="side">
      <section class="quiz">
        <h3>Pregunta r√°pida</h3>
        <div class="quiz-question" id="qText">
          ¬øEn qu√© grupo se clasifica ‚ÄúCaja y Bancos‚Äù?
        </div>
        <div class="options" id="qOptions"></div>
        <div class="quiz-actions">
          <button class="btn" id="btnCheck">Comprobar</button>
          <button class="btn ghost" id="btnSkip">Saltar</button>
        </div>
        <div class="feedback" id="qFeedback"></div>
      </section>

      <section class="stats">
        <div>
          <span class="pill good">Aciertos: <b id="hits">0</b></span>
          <span class="pill bad">Errores: <b id="fails">0</b></span>
        </div>
        <div style="font-size:11px;color:var(--muted)">
          <span class="kbd">R</span> Reiniciar ¬∑
          <span class="kbd">H</span> Ayuda ¬∑
          <span class="kbd">Q</span> Nueva pregunta
        </div>
      </section>
    </aside>
  </section>

  <footer>Hecho con NextSkill ‚Äî Practica la f√≥rmula A = P + C de forma interactiva ¬∑ ¬© 2025</footer>
</div>

<!-- TOAST -->
<div class="toast" id="toast"><span>üí°</span><span id="toastMsg"></span></div>

<script>
/* ===============================
   UTILIDADES
   =============================== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => {
  const sign = n < 0 ? "-" : "";
  return sign + "$" + Math.abs(n).toLocaleString("es-MX");
};
function showToast(msg){
  const t = $("#toast"), m=$("#toastMsg");
  m.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1500);
}

/* ===============================
   DATOS DEL JUEGO
   =============================== */
const PARTIDAS_BASE = [
  {nombre:"Caja y Bancos", monto:12000, zona:"activo", sub:"Circulante"},
  {nombre:"Cuentas por Cobrar (90 d√≠as)", monto:18000, zona:"activo", sub:"Circulante"},
  {nombre:"Inventarios", monto:15000, zona:"activo", sub:"Circulante"},
  {nombre:"Propiedad, Planta y Equipo", monto:90000, zona:"activo", sub:"No circulante"},
  {nombre:"Depreciaci√≥n Acumulada (‚Äì)", monto:-8000, zona:"activo", sub:"Correctiva"},
  {nombre:"Gastos Pagados por Anticipado", monto:4000, zona:"activo", sub:"Circulante"},
  {nombre:"Clientes Incobrables (estimaci√≥n ‚Äì)", monto:-1200, zona:"activo", sub:"Correctiva"},

  {nombre:"Proveedores", monto:10000, zona:"pasivo", sub:"Corto plazo"},
  {nombre:"Impuestos por pagar", monto:3000, zona:"pasivo", sub:"Corto plazo"},
  {nombre:"Acreedores diversos", monto:4500, zona:"pasivo", sub:"Corto plazo"},
  {nombre:"Cr√©dito bancario 5 a√±os", monto:22000, zona:"pasivo", sub:"Largo plazo"},
  {nombre:"Documentos por pagar a 2 a√±os", monto:14000, zona:"pasivo", sub:"Largo plazo"},

  {nombre:"Capital Social", monto:50000, zona:"capital", sub:"Contribuido"},
  {nombre:"Utilidades Retenidas", monto:12000, zona:"capital", sub:"Ganado"},
  {nombre:"Resultado del ejercicio", monto:6500, zona:"capital", sub:"Ganado"}
];

const PREGUNTAS = [
  {
    texto:"Una deuda bancaria a 5 a√±os pertenece a‚Ä¶",
    opciones:["Pasivo a corto plazo","Pasivo a largo plazo","Activo no circulante","Capital ganado"],
    correcta:1,
    exp:"Es una obligaci√≥n mayor a un a√±o, por eso es pasivo a largo plazo."
  },
  {
    texto:"La f√≥rmula del Balance General es‚Ä¶",
    opciones:["A + P = C","A = P + C","A + C = P","P = A + C"],
    correcta:1,
    exp:"Siempre: Activo = Pasivo + Capital."
  },
  {
    texto:"¬øC√≥mo se clasifica ‚ÄúCaja y Bancos‚Äù?",
    opciones:["Activo circulante","Pasivo a corto plazo","Capital contribuido","Gasto del periodo"],
    correcta:0,
    exp:"Es efectivo disponible, por eso es Activo circulante."
  },
  {
    texto:"La depreciaci√≥n acumulada se presenta como‚Ä¶",
    opciones:["Pasivo","Cuenta correctiva de activo","Capital","Ingreso"],
    correcta:1,
    exp:"Reduce el valor del activo, es cuenta correctiva de activo."
  },
  {
    texto:"‚ÄúUtilidades retenidas‚Äù pertenece a‚Ä¶",
    opciones:["Activo","Pasivo","Capital ganado","Capital contribuido"],
    correcta:2,
    exp:"Son utilidades acumuladas de la empresa: capital ganado."
  },
  {
    texto:"‚ÄúProveedores‚Äù se clasifica como‚Ä¶",
    opciones:["Activo circulante","Pasivo a corto plazo","Pasivo a largo plazo","Capital ganado"],
    correcta:1,
    exp:"Son deudas con proveedores a corto plazo, por eso pasivo a corto plazo."
  },
  {
    texto:"Si A = 150, P = 40, ¬øcu√°nto debe ser C?",
    opciones:["110","40","190","150"],
    correcta:0,
    exp:"A = P + C ‚Üí 150 = 40 + C ‚Üí C = 110."
  },
  {
    texto:"Los gastos pagados por anticipado son‚Ä¶",
    opciones:["Activo","Pasivo","Capital","Ingreso"],
    correcta:0,
    exp:"A√∫n representan un derecho a recibir servicios, por eso son activo."
  }
];

/* ===============================
   ESTADO
   =============================== */
const state = {
  score:0,
  streak:0,
  round:1,
  maxRounds:10,
  hits:0,
  fails:0,
  lives:3,
  timeMax:60,
  time:60,
  timer:null,
  practice:false,
  bankItems:[],     // partidas que quedan en el banco
  qIndex:null,
  qAnswered:false,
  qSelected:null
};

/* ===============================
   HUD
   =============================== */
const ui = {
  score:$("#score"),
  streak:$("#streak"),
  round:$("#round"),
  best:$("#best"),
  hits:$("#hits"),
  fails:$("#fails"),
  lives:$("#lives"),
  timebar:$("#timebar"),
  timeleft:$("#timeleft"),
  bank:$("#bank"),
  sumA:$("#sum-activo"),
  sumP:$("#sum-pasivo"),
  sumC:$("#sum-capital"),
  qText:$("#qText"),
  qOptions:$("#qOptions"),
  qFeedback:$("#qFeedback"),
  modeTag:$("#modeTag")
};

function loadBest(){
  const b = localStorage.getItem("bg_best") || "0";
  ui.best.textContent = b;
}
function saveBest(){
  const b = parseInt(localStorage.getItem("bg_best") || "0",10);
  if(state.score > b){
    localStorage.setItem("bg_best", String(state.score));
    ui.best.textContent = state.score;
  }
}

function renderLives(){
  ui.lives.innerHTML = "";
  for(let i=0;i<3;i++){
    const d = document.createElement("div");
    d.className = "life" + (i<state.lives ? "" : " out");
    ui.lives.appendChild(d);
  }
}

function setTime(t){
  state.time = Math.max(0, Math.min(t, state.timeMax));
  ui.timeleft.textContent = String(state.time).padStart(2,"0");
  ui.timebar.style.width = (state.time/state.timeMax*100)+"%";
}

function startTimer(){
  clearInterval(state.timer);
  if(state.practice){
    setTime(state.timeMax);
    return;
  }
  setTime(state.timeMax);
  state.timer = setInterval(()=>{
    setTime(state.time-1);
    if(state.time<=0){
      clearInterval(state.timer);
      loseLife("‚è±Ô∏è Tiempo agotado");
    }
  },1000);
}

function updateHUD(){
  ui.score.textContent = state.score;
  ui.streak.textContent = state.streak;
  ui.round.textContent = state.round;
  ui.hits.textContent = state.hits;
  ui.fails.textContent = state.fails;
  renderLives();
}

/* ===============================
   BANCO + ZONAS
   =============================== */
function newRound(){
  clearInterval(state.timer);
  if(state.round>state.maxRounds){
    showToast("üèÅ ¬°Completaste todas las rondas! Se reinicia el juego.");
    resetGame();
    return;
  }

  // seleccionar 6-8 partidas aleatorias
  const shuffled = [...PARTIDAS_BASE].sort(()=>Math.random()-0.5);
  const n = 6;
  state.bankItems = shuffled.slice(0,n).map((p,idx)=>({
    id:"p_"+Date.now()+"_"+idx,
    ...p
  }));

  // limpiar zonas
  $$("#zones .zone-list").forEach(z=>z.innerHTML="");
  ui.sumA.textContent = "$0";
  ui.sumP.textContent = "$0";
  ui.sumC.textContent = "$0";

  renderBank();
  startTimer();
  updateHUD();
}

function renderBank(){
  ui.bank.innerHTML = "";
  state.bankItems.forEach(item=>{
    const d = document.createElement("div");
    d.className = "card-item";
    d.draggable = true;
    d.dataset.id = item.id;
    d.innerHTML = `
      <h4>${item.nombre}</h4>
      <div class="card-meta">
        <span>${item.sub}</span>
        <span class="card-amt">${fmt(item.monto)}</span>
      </div>
    `;
    d.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/plain", item.id);
    });
    ui.bank.appendChild(d);
  });
}

function setupDropzones(){
  $$(".dropzone").forEach(zone=>{
    zone.addEventListener("dragover", e=>{
      e.preventDefault();
      zone.classList.add("active");
    });
    zone.addEventListener("dragleave", ()=>{
      zone.classList.remove("active");
    });
    zone.addEventListener("drop", e=>{
      e.preventDefault();
      zone.classList.remove("active");
      const id = e.dataTransfer.getData("text/plain");
      if(!id) return;
      handleDrop(id, zone.dataset.zone);
    });
  });
}

function handleDrop(id, targetZone){
  const idx = state.bankItems.findIndex(p=>p.id===id);
  if(idx===-1) return; // ya se us√≥

  const item = state.bankItems[idx];
  const correct = (item.zona === targetZone);

  if(correct){
    state.bankItems.splice(idx,1); // lo saco del banco
    placeInZone(item, targetZone);
    addScore(10);
    addStreak();
    showToast("‚úÖ Correcto: "+item.nombre);
  }else{
    addScore(-5);
    resetStreak();
    loseLife("‚ùå Clasificaci√≥n incorrecta");
    showToast("Revisa si es Activo, Pasivo o Capital");
  }

  if(state.bankItems.length===0){
    // ronda terminada
    state.hits++;
    state.round++;
    updateHUD();
    saveBest();
    setTimeout(()=>{
      showToast("‚ö° Nueva ronda");
      newRound();
      newQuestion();   // tambi√©n nueva pregunta
    },700);
  }
  recalcSums();
}

function placeInZone(item, zoneKey){
  const cont = document.querySelector(`.dropzone[data-zone="${zoneKey}"] .zone-list`);
  const d = document.createElement("div");
  d.className = "card-item";
  d.innerHTML = `
    <h4>${item.nombre}</h4>
    <div class="card-meta">
      <span>${item.sub}</span>
      <span class="card-amt">${fmt(item.monto)}</span>
    </div>
  `;
  cont.appendChild(d);
}

function recalcSums(){
  let sumA=0,sumP=0,sumC=0;
  const readZone = (zoneKey)=>{
    const el = document.querySelector(`.dropzone[data-zone="${zoneKey}"] .zone-list`);
    return Array.from(el.children).reduce((acc,card)=>{
      const amtText = card.querySelector(".card-amt").textContent.replace(/[^\d\-]/g,"");
      return acc + (parseInt(amtText||"0",10));
    },0);
  };
  sumA = readZone("activo");
  sumP = readZone("pasivo");
  sumC = readZone("capital");
  ui.sumA.textContent = fmt(sumA);
  ui.sumP.textContent = fmt(sumP);
  ui.sumC.textContent = fmt(sumC);
}

/* ===============================
   QUIZ (SIN BUGS)
   =============================== */
function newQuestion(){
  // elegir pregunta aleatoria distinta a la anterior
  let idx;
  do{
    idx = Math.floor(Math.random()*PREGUNTAS.length);
  }while(idx===state.qIndex);
  state.qIndex = idx;
  state.qAnswered = false;
  state.qSelected = null;

  const q = PREGUNTAS[idx];
  ui.qText.textContent = q.texto;
  ui.qFeedback.textContent = "";

  ui.qOptions.innerHTML = "";
  q.opciones.forEach((txt,i)=>{
    const d = document.createElement("div");
    d.className = "option";
    d.dataset.index = i;
    d.innerHTML = `<span>${txt}</span><span>${i+1}</span>`;
    d.addEventListener("click", ()=>{
      if(state.qAnswered) return; // ya se calific√≥, esperar a nueva pregunta
      state.qSelected = i;
      // limpiar selecci√≥n visual previa
      $$(".option").forEach(o=>o.classList.remove("selected"));
      d.classList.add("selected");
    });
    ui.qOptions.appendChild(d);
  });
}

function gradeQuestion(){
  if(state.qAnswered) return;
  const q = PREGUNTAS[state.qIndex];
  if(state.qSelected===null){
    showToast("Elige una opci√≥n antes de comprobar");
    return;
  }
  state.qAnswered = true;

  const opts = $$(".option");
  opts.forEach((o,i)=>{
    o.classList.remove("selected");
    if(i===q.correcta) o.classList.add("correct");
    if(i===state.qSelected && state.qSelected!==q.correcta) o.classList.add("wrong");
  });

  if(state.qSelected===q.correcta){
    ui.qFeedback.textContent = "‚úî Correcto: "+q.exp;
    ui.qFeedback.className = "feedback good";
    state.hits++;
    addScore(5);
    addStreak();
  }else{
    ui.qFeedback.textContent = "‚úñ Incorrecto: "+q.exp;
    ui.qFeedback.className = "feedback bad";
    state.fails++;
    addScore(-3);
    resetStreak();
    loseLife("Error en la pregunta");
  }
  updateHUD();
  saveBest();

  // generar nueva pregunta en 1.2s
  setTimeout(()=>{ newQuestion(); },1200);
}

/* ===============================
   PUNTOS, VIDAS
   =============================== */
function addScore(n){
  state.score = Math.max(0, state.score + n);
  ui.score.textContent = state.score;
}
function addStreak(){
  state.streak++;
  ui.streak.textContent = state.streak;
  if(state.streak>0 && state.streak%3===0){
    addScore(5);
    showToast("üî• Bonificaci√≥n por racha +5");
  }
}
function resetStreak(){
  state.streak = 0;
  ui.streak.textContent = 0;
}

function loseLife(msg){
  if(state.practice) return; // en pr√°ctica no restamos vidas
  state.lives--;
  renderLives();
  if(msg) showToast(msg);
  if(state.lives<=0){
    clearInterval(state.timer);
    showToast("üíÄ Game Over ‚Äî Puntaje: "+state.score);
    setTimeout(resetGame,1300);
  }
}

/* ===============================
   FLUJOS PRINCIPALES
   =============================== */
function resetGame(){
  clearInterval(state.timer);
  state.score = 0;
  state.streak = 0;
  state.round = 1;
  state.hits = 0;
  state.fails = 0;
  state.lives = 3;
  state.timeMax = 60;
  state.practice = false;
  updateHUD();
  newRound();
  newQuestion();
  showToast("Juego reiniciado");
}

function setPractice(on){
  state.practice = on;
  $("#modeTag").textContent = on ? "Modo: Pr√°ctica (sin tiempo ni vidas)" : "Modo: Arcade";
  state.lives = on ? 3 : 3;
  updateHUD();
  newRound();
  newQuestion();
}

/* ===============================
   EVENTOS
   =============================== */
document.getElementById("btnStart").addEventListener("click", ()=>{
  setPractice(false);
});
document.getElementById("btnPractice").addEventListener("click", ()=>{
  setPractice(true);
});
document.getElementById("btnHelp").addEventListener("click", ()=>{
  showToast("Arrastra partidas a A, P o C. A = P + C. Responde el quiz a la derecha.");
});
document.getElementById("btnCheck").addEventListener("click", gradeQuestion);
document.getElementById("btnSkip").addEventListener("click", ()=>{
  showToast("Pregunta nueva");
  newQuestion();
});

window.addEventListener("keydown", e=>{
  if(e.key==="r" || e.key==="R"){
    e.preventDefault();
    resetGame();
  }
  if(e.key==="h" || e.key==="H"){
    e.preventDefault();
    showToast("Ayuda: A = P + C. Activo: recursos; Pasivo: deudas; Capital: patrimonio.");
  }
  if(e.key==="q" || e.key==="Q"){
    e.preventDefault();
    newQuestion();
  }
});

/* ===============================
   INIT
   =============================== */
loadBest();
setupDropzones();
updateHUD();
newRound();
newQuestion();
</script>
</body>
</html>


